from flask import Flask, jsonify, render_template
from flask_wtf.csrf import CSRFProtect
import subprocess,re, psutil, netifaces, os, requests
import RPi.GPIO as GPIO

GPIO.setmode(GPIO.BCM)
GPIO.setup(17, GPIO.IN)
interfaces = netifaces.interfaces()

#! pip intsall flask flask_wtf psutil netifaces

app = Flask(__name__, template_folder='html/')
csrf = CSRFProtect()
csrf.init_app(app)

@app.route('/')
def home():
    ip, wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return render_template('home.html', 
                           wifi_icon=wifi_icon, 
                           ssid=ssid, 
                           temp=temp, 
                           temp_icon=temp_icon, 
                           usage=usage, 
                           fan=fan,
                           ip=ip)


@app.route('/bt')
def about():
    ip, wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return render_template('bt.html', 
                           wifi_icon=wifi_icon, 
                           ssid=ssid, 
                           temp=temp, 
                           temp_icon=temp_icon, 
                           usage=usage, 
                           fan=fan,
                           ip=ip)


@app.route('/wifi')
def contact():
    ip, wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return render_template('wifi.html', 
                           wifi_icon=wifi_icon, 
                           ssid=ssid, 
                           temp=temp, 
                           temp_icon=temp_icon, 
                           usage=usage, 
                           fan=fan,
                           ip=ip)


@app.route('/radio')
def radio():
    ip, wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return render_template('radio.html', 
                           wifi_icon=wifi_icon, 
                           ssid=ssid, 
                           temp=temp, 
                           temp_icon=temp_icon, 
                           usage=usage, 
                           fan=fan,
                           ip=ip)


@app.route('/password')
def password():
    ip, wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return render_template('password.html', 
                           wifi_icon=wifi_icon, 
                           ssid=ssid,
                           temp=temp, 
                           temp_icon=temp_icon, 
                           usage=usage, 
                           fan=fan,
                           ip=ip)


@app.route('/jammer')
def jammer():
    ip, wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return render_template('jammer.html', 
                           wifi_icon=wifi_icon, 
                           ssid=ssid, 
                           temp=temp, 
                           temp_icon=temp_icon, 
                           usage=usage, 
                           fan=fan,
                           ip=ip)


@csrf.exempt
@app.route('/update-system')
def update_system():
    ip, wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return jsonify(wifi_icon=wifi_icon, 
                   ssid=ssid, 
                   temp=temp,
                   temp_icon=temp_icon, 
                   usage=usage, 
                   fan=fan)


@csrf.exempt
@app.route('/version')
def version():
    path = os.path.join(app.root_path, 'version')
    with open(path, 'r') as f:
        version = f.read()
    return version


@csrf.exempt
@app.route('/latest')
def latest():
    url = 'https://raw.githubusercontent.com/Toomas633/Pentest-Zero/main/version';
    response = requests.get(url)
    if response.status_code == 200:
        file_contents = response.text
        return file_contents


def wifi_strength():
    for interface in interfaces:
        if interface == 'lo':
            continue
        iface = netifaces.ifaddresses(interface).get(netifaces.AF_INET)
        if iface != None:
            for link in iface:
                if 'addr' in link:
                    ip = link['addr']
                    break
            break 
    cmd = "iwconfig wlan0 | grep 'Signal level'"
    output = subprocess.check_output(cmd, shell=True).decode()
    signal_strength = int(re.search('Signal level=(-\d+)', output).group(1))
    cmd = "iwgetid -r"
    ssid = subprocess.check_output(cmd, shell=True).decode().strip()
    if signal_strength > -50:
        icon = 'wifi-4-bars'
    elif signal_strength > -60:
        icon = 'wifi-3-bars'
    elif signal_strength > -70:
        icon = 'wifi-2-bars'
    elif signal_strength > -80:
        icon = 'wifi-1-bar'
    else:
        icon = 'wifi-0-bars'
    return ip, icon, ssid


def cpu():
    if GPIO.input(17) == GPIO.HIGH:
        fan = "fan-rotate"
    else:
        fan = "fan-static"
    usage = int(psutil.cpu_percent())
    result = subprocess.run(['vcgencmd', 'measure_temp'],
                            capture_output=True, text=True)
    temp_str = result.stdout.strip().split('=')[1].split("'")[0]
    temp = round(float(temp_str))
    if temp > 60:
        icon = "temp-mid"
    elif temp > 75:
        icon = "temp-high"
    else:
        icon = "temp-low"
    return fan, temp, usage, icon


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0')
