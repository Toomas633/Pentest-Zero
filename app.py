from flask import Flask, render_template
import subprocess
import re
import psutil
import RPi.GPIO as GPIO

GPIO.setmode(GPIO.BCM)
GPIO.setup(17, GPIO.IN)

#! pip intsall flask psutil

app = Flask(__name__, template_folder='html/')


@app.route('/')
def home():
    wifi_icon, ssid = wifi_strength()
    fan, temp, usage, temp_icon = cpu()
    return render_template('home.html', 
                           wifi_icon=wifi_icon, 
                           ssid=ssid, temp=temp, 
                           temp_icon=temp_icon, 
                           usage=usage, 
                           fan=fan)


@app.route('/bt')
def about():
    return 'This is the bt page'


@app.route('/wifi')
def contact():
    return 'This is the wifi page'


@app.route('/radio')
def contact():
    return 'This is the radio page'


@app.route('/password')
def contact():
    return 'This is the password page'


@app.route('/jammer')
def contact():
    return 'This is the jammer page'


def wifi_strength():
    cmd = "iwconfig wlan0 | grep 'Signal level'"
    output = subprocess.check_output(cmd, shell=True).decode()
    signal_strength = int(re.search('Signal level=(-\d+)', output).group(1))
    cmd = "iwgetid -r"
    ssid = subprocess.check_output(cmd, shell=True).decode().strip()
    if signal_strength > -50:
        icon = 'wifi-4-bars'
    elif signal_strength > -60:
        icon = 'wifi-3-bars'
    elif signal_strength > -70:
        icon = 'wifi-2-bars'
    elif signal_strength > -80:
        icon = 'wifi-1-bar'
    else:
        icon = 'wifi-0-bars'
    return icon, ssid


def cpu():
    if GPIO.input(17) == GPIO.HIGH:
        fan = "fan-rotate"
    else:
        fan = "fan-static"
    usage = int(psutil.cpu_percent())
    result = subprocess.run(['vcgencmd', 'measure_temp'],
                            capture_output=True, text=True)
    temp_str = result.stdout.strip().split('=')[1].split("'")[0]
    temp = round(float(temp_str))
    if temp > 60:
        icon = "temp-mid"
    elif temp > 75:
        icon = "temp-high"
    else:
        icon = "temp-low"
    return fan, temp, usage, icon


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0')
